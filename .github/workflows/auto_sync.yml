name: æ¯æ—¥é“œä»·è‡ªåŠ¨åŒæ­¥

on:
  schedule:
    # UTC 1:30 = åŒ—äº¬æ—¶é—´ 9:30
    - cron: '30 1 * * *'
  workflow_dispatch: # å…è®¸ä½ éšæ—¶æ‰‹åŠ¨ç‚¹å‡» "Run workflow" æµ‹è¯•

# âœ… ä¿®æ­£ 1ï¼šå¢åŠ å†™æƒé™ï¼Œè¿™æ˜¯æœºå™¨äººä¿®æ”¹ä»“åº“æ–‡ä»¶çš„åŸºç¡€
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: å®‰è£…æœ€æ–°ä¾èµ–
        # âœ… ä¿®æ­£ 2ï¼šç¡®ä¿å®‰è£… 2026 å¹´æ ‡å‡† SDK
        run: npm install @google/generative-ai

      - name: æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          # å¿…é¡»ç¡®ä¿åœ¨ GitHub Secrets ä¸­è®¾ç½®äº† GEMINI_API_KEY
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/dailyUpdate.js

      - name: âœ… ä¿®æ­£ 3ï¼šå¥å£®çš„æäº¤ä¸æ¨é€é€»è¾‘
        run: |
          # é…ç½®æœºå™¨äººèº«ä»½
          git config --global user.name "CopperPriceBot"
          git config --global user.email "bot@github.com"
          
          # ä»…æš‚å­˜æ•°æ®æ–‡ä»¶ï¼Œå¿½ç•¥è‡ªåŠ¨ç”Ÿæˆçš„ package.json å˜åŠ¨
          git add data/copper.csv
          
          # æ ¸å¿ƒæ£€æŸ¥ï¼šå¯¹æ¯”æš‚å­˜åŒºï¼Œå¦‚æœ data/copper.csv çœŸçš„æœ‰å˜åŒ–æ‰æäº¤
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œæ­£åœ¨æäº¤å¹¶æ¨é€..."
            git commit -m "ğŸ“ˆ è‡ªåŠ¨æ›´æ–°é“œä»·: $(date +'%Y-%m-%d')"
            git push
          else
            echo "âš ï¸ ä»Šæ—¥æ•°æ®æ— å˜åŒ–ï¼ˆå¯èƒ½æ˜¯ä»·æ ¼æœªå˜æˆ–è„šæœ¬è·å–å¤±è´¥ï¼‰ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 0
          fi
