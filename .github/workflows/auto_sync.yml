name: æ¯æ—¥é“œä»·è‡ªåŠ¨åŒæ­¥

on:
  schedule:
    # UTC 1:30 = åŒ—äº¬æ—¶é—´ 9:30
    - cron: '30 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

# å…³é”®ï¼šèµ‹äºˆè„šæœ¬å†™å…¥ä»“åº“çš„æƒé™
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: å®‰è£…ä¾èµ–
        # åªéœ€è¦å®‰è£… Gemini SDKï¼Œä¸å†éœ€è¦ googleapis
        run: npm install @google/genai

      - name: æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          # åªä¿ç•™ Gemini çš„ Keyï¼ŒSheet çš„ Key å·²ç»ä¸éœ€è¦äº†
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/dailyUpdate.js

      - name: æäº¤å¹¶æ¨é€æ•°æ®æ›´æ”¹
        run: |
          # é…ç½® GitHub æœºå™¨äººèº«ä»½
          git config --global user.name "CopperPriceBot"
          git config --global user.email "bot@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if [[ -n $(git status -s) ]]; then
            echo "æ£€æµ‹åˆ°ä»·æ ¼æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            git add data/copper.csv
            git commit -m "ğŸ“ˆ è‡ªåŠ¨æ›´æ–°é“œä»·: $(date +'%Y-%m-%d')"
            git push
          else
            echo "ä»Šæ—¥ä»·æ ¼æœªå˜æˆ–è„šæœ¬æœªäº§ç”Ÿæ–°æ•°æ®ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
