name: æ¯æ—¥é“œä»·è‡ªåŠ¨åŒæ­¥

on:
  schedule:
    - cron: '30 1 * * *' # UTC 1:30 = åŒ—äº¬æ—¶é—´ 9:30
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: å®‰è£…ä¾èµ–
        run: npm install @google/generative-ai

      - name: æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/dailyUpdate.js

      - name: æäº¤å¹¶æ¨é€æ•°æ®æ›´æ”¹
        run: |
          git config --global user.name "CopperPriceBot"
          git config --global user.email "bot@github.com"
          
          # ğŸ” å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ git status --porcelain ä¸“é—¨æ£€æŸ¥ data/copper.csv æ˜¯å¦æœ‰å˜åŒ–
          if git status --porcelain | grep "data/copper.csv"; then
            echo "âœ… æ£€æµ‹åˆ°é“œä»·æ•°æ®æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            git add data/copper.csv
            git commit -m "ğŸ“ˆ è‡ªåŠ¨æ›´æ–°é“œä»·: $(date +'%Y-%m-%d')"
            git push
          else
            echo "âš ï¸ ä»Šæ—¥æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼ˆå¯èƒ½æ˜¯è„šæœ¬æŠ¥é”™æˆ–ä»·æ ¼æœªå˜ï¼‰ï¼Œè·³è¿‡æäº¤ã€‚"
            # å³ä½¿æ²¡æäº¤ä¹Ÿä¸ç®—å¤±è´¥ï¼Œä¿æŒç»¿ç¯
            exit 0
          fi
